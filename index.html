<!DOCTYPE html>
<html>

    <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script src="plotly-latest.min.js"></script>
    
    <link href="./UI/jquery-ui.css" rel="stylesheet">
	<style>
        body{
            font: 62.5% "Trebuchet MS", sans-serif;
            margin: 50px;
        }
        .demoHeaders {
            margin-top: 2em;
        }
        #dialog-link {
            padding: .4em 1em .4em 20px;
            text-decoration: none;
            position: relative;
        }
        #dialog-link span.ui-icon {
            margin: 0 5px 0 0;
            position: absolute;
            left: .2em;
            top: 50%;
            margin-top: -8px;
        }
        #icons {
            margin: 0;
            padding: 0;
        }               
        
        #icons li {
            margin: 2px;
            position: relative;
            padding: 4px 0;
            cursor: pointer;
            float: left;
            list-style: none;
        }
        #icons span.ui-icon {
            float: left;
            margin: 0 4px;
        }
        
        #radioset label { width: 200px }
        
        #fluidSpeedSlider { 
            width: 300px;                            
        }
        #fluidSpeedSlider .ui-slider-range { background: #007fff; }
                
        .fakewindowcontain .ui-widget-overlay {
            position: absolute;
        }
        select {
            width: 200px;
        }
	</style>

    <title>Experiment 1 - Drag coefficents</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=620">
    <style>
        body {background-color:#ffffff; font-family:Arial, sans-serif; font-size:14px;
                        text-align:center;}						/* gray background, center everything */
        p {margin-left:auto; margin-right:auto; width:600px;}	/* keep paragraphs narrow and centered */
        input {font-size:115%;}									/* make buttons bigger */	
        li {text-align:left;}
    </style>
    <style type="text/css"></style></head>

    <body>

    <h2>Fluid Dynamics Toy Box</h2>
    
    <!-- Info label-->    
    <div>
    Force (drag): <span id="dragLabel">...</span> 
    FPS: <span id="fpsLabel">...</span> 
    </div>    

    <canvas id="theCanvas" width="600" height="240">This application runs only in modern
    browsers. For best results, use Google Chrome.</canvas>

    <!-- Reset / Play -->        
    <div>
        <input id="resetFluidButton" type="button" onclick="fds._resetFluid()" value="Reset">	    
        <input id="startButton" type="button" onclick="fds.startStop()" value="Start">        
    </div>
    
    <!-- Visualization -->        
    <form id="myform" style="margin-top: 1em;">
        <div id="radioset">
            <input type="radio" id="radio1" value="0" name="radio"><label for="radio1">Density</label><br>
            <input type="radio" id="radio2" value="1" name="radio"><label for="radio2">XVel</label><br>
            <input type="radio" id="radio3" value="2" name="radio"><label for="radio3">YVel</label><br>
            <input type="radio" id="radio4" value="3" name="radio"><label for="radio4">Speed</label><br>
            <input type="radio" id="radio5" value="4" name="radio" checked="checked"><label for="radio5">Curl</label><br>
        </div>
    </form>
    
    <br>
    
    <!-- Fluid Speed Slider -->    
    <div align="left">
        <label for="fluidSpeedValue">Fluid speed:</label>
        <input type="text" id="fluidSpeedLabel" readonly style="border:0; color:#f6931f; font-weight:bold;">

        <div id="fluidSpeedSlider"></div>
    </div>
             
    <div id="tester" style="width:600px;height:250px;"></div>

    <script src="./Fluid Dynamics Simulation_files/barrierdata.js"></script>
    <script src="helper.js"></script>
    <script src="LBESolver_JS.js"></script>   
    <script src="fluidDynamics.js"></script>   

    <script src="./UI/external/jquery/jquery.js"></script>
    <script src="./UI/jquery-ui.js"></script>
    
    <!-- Just an interface to the lattice_boltzmann settings -->
    <script>

        // Find best approximation for data using linear regression. 
        // Uses a nieve iterative algorithm and assumes bias is zero.
        function linearRegress(data) {
            theta = 0.0;
            n = results.length;
            for (var i = 0; i < 99; i++) {
                loss = 0.0;
                grad = 0.0;
            
                for (var index in results) {            
                    loss += (0.5 * Math.pow(results[index] - index * theta,2)) / n;
                    grad += (results[index] - index * theta) / n;
                }
                console.log(theta+":loss="+loss);
                theta += grad * 0.1;
            }
            return theta;            
        }
        
    
        // initialization
        fds = new FluidDynamics();
        fds.reset();

                            
        $(function() {
            $( "#fluidSpeedSlider" ).slider({
                range: "min",
                value: 0.10,
                min: 0.00,
                step: 0.0125,
                max: 0.18,
                slide: function( event, ui ) {
                    $( "#fluidSpeedLabel" ).val( ui.value );
                    try {
                        _adjustSpeed()
                    } catch(exception) {                       
                    }
                }
            });
            $( "#fluidSpeedLabel" ).val( $( "#fluidSpeedSlider" ).slider( "value" ) );
        });
        
        // globals to our UI controls
        var speedLabel = document.getElementById('fluidSpeedLabel');
        var speedSlider = document.getElementById('fluidSpeedSlider');	
        var plotButtons = document.getElementById('radioset');	
        
        // get jquery up and running
        $( "#radioset" ).buttonset();
        
        $( "#resetFluidButton" ).button();
        $( "#startButton" ).button();
        
        $( "#plotButton" ).button();                              
        $( "#plotButton2" ).button();                              
        
        // hooks
        
        $( "#radioset" ).click(function() {
            _setPlot()
        });
        
        fds.ui.dragLabel = document.getElementById('dragLabel');	
        fds.ui.fpsLabel = document.getElementById('fpsLabel');

        // start the simulation on page load
        fds.startStop();
        
        _adjustSpeed()
        
        var results = []
        var sample_number
        var sample_count 
        var sample_step 
        var sample_start
        var sample_time = 1000
        
        function currentDragForceMagnitude() {
            var Fx = barrierFx;
            var Fy = barrierFy;
            return Math.sqrt(Fx*Fx + Fy*Fy).toFixed(3);            
        }
        
        // Takes the next sample for the plot
        function nextSample() {
            console.log("Sample."+sample_number)            
            
            // Take sample from previous step.
            results[fds.speed] = currentDragForceMagnitude()
            
            sample_number = sample_number + 1

            // Set the next fluid speed
            fds.speed = sample_start + sample_number * sample_step
            
            // Cue up a new step
            if (sample_number < sample_count) {
                window.setTimeout(nextSample,sample_time)
            } else {
                // otherwise plot the results
                drawPlot()
            }
        }
        
        function start_experiment(start,step,count) {
            console.log("Beginning Auto Plot")
            
            sample_number = 0
            sample_time = 1000
            sample_count = count
            sample_start = start
            sample_step = step 
            
            fds.speed = sample_start
            
            initFluid()
                   
            setTimeout(nextSample,sample_time);
        }

        // Plot current drag on graph
        function autoPlot_laminar() {
            start_experiment(0.0,0.005,10)           
        }
        
        // Plot current drag on graph
        function autoPlot_nonlaminar() {
            start_experiment(0.1,0.010,10)
            
        }
        
        function drawPlot() {
            TESTER = document.getElementById('tester');
            
            console.log(results)
            
            var _x = []
            var _y = []

            for (var index in results) {            
                _x.push(index)
                _y.push(results[index])            
            }
                
            Plotly.plot( TESTER, [{
            x: _x,
            y: _y, }], {        
            margin: { t: 0 } } );
            
            // stats analysis
            theta = linearRegress(results);
            console.log("Theta = "+theta)
            max_x = _x[_x.length-1]
            max_y = _y[_y.length-1]
            Plotly.plot( TESTER, [{
            x: [0,max_x],
            y: [0,theta*max_x], }], {        
            margin: { t: 0 } } );
            
        }
        
        // Show value of flow speed setting:
        function _adjustSpeed() {            
            console.log("adjusting")
            value = $( "#fluidSpeedSlider" ).slider("value");
            console.log(value)
            fds.speed = value
            speedLabel.innerHTML = Number(value).toFixed(3);        
            
        }
        
        function _setPlot() {
            value = $('input[name=radio]:checked', '#myform').val();
            fds.plotSelect = value;
        }
                     

    </script>

    </body>
 </html>